<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>BetterPonymotes Opera Background Page</title>
  <script src="sr-data.js" type="text/javascript"></script>
  <script>
    // TODO: Move this script out for consistency's sake.

    // Load/initialize prefs
    var prefs;
    if(localStorage.prefs === undefined) {
        prefs = {
            "enableNSFW": false,
            "enableExtraCSS": true,
        };
    } else {
        prefs = JSON.parse(localStorage.prefs);
    }

    if(!prefs.enabledSubreddits) {
        prefs.enabledSubreddits = {};
    }

    for(var sr in sr_data) {
        if(prefs.enabledSubreddits[sr] === undefined) {
            prefs.enabledSubreddits[sr] = true;
        }
    }
    localStorage.prefs = JSON.stringify(prefs);

    // XHR request from background process = load file data. Weird.
    function get_file_data(filename) {
        var request = new XMLHttpRequest();
        request.open("GET", filename, false);
        request.send();

        if(!request.responseText) {
            console.log("ERROR: Can't read from file: " + filename);
            return;
        } else {
            return request.responseText;
        }
    }

    // Content script requests
    opera.extension.onmessage = function(event) {
        var message = event.data;

        switch(message.method) {
            case "get_prefs":
                event.source.postMessage({
                    "method": "prefs",
                    "prefs": JSON.parse(localStorage.prefs)
                });
                break;

            case "get_file":
                var data = get_file_data(message.filename);

                if(data) {
                    event.source.postMessage({
                        "method": "file_loaded",
                        "filename": message.filename,
                        "data": data
                    });
                }
                break;

            default:
                console.log("ERROR: Unknown request from content script: " + message.method);
                break;
        }
    };
  </script>
</head>
<body>
BetterPonymotes
</body>
</html>

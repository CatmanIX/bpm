<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>BetterPonymotes Opera Background Page</title>
  <script src="sr-data.js" type="text/javascript"></script>
  <script>
    // TODO: Move this script out for consistency's sake.

    // Load/initialize prefs
    var prefs;
    if(localStorage.prefs === undefined) {
        prefs = {
            "enableNSFW": false,
            "enableExtraCSS": true,
            "enabledSubreddits": {},
            "showUnknownEmotes": true,
            "searchLimit": 200,
            "searchBoxInfo": [600, 25, 600, 450]
        };
    } else {
        prefs = JSON.parse(localStorage.prefs);
    }

    if(!prefs.enabledSubreddits) {
        prefs.enabledSubreddits = {};
    }

    for(var sr in sr_data) {
        if(prefs.enabledSubreddits[sr] === undefined) {
            prefs.enabledSubreddits[sr] = true;
        }
    }

    if(prefs.showUnknownEmotes === undefined) {
        prefs.showUnknownEmotes = true;
    }

    if(prefs.searchLimit === undefined) {
        prefs.searchLimit = 200;
    }

    if(prefs.searchBoxInfo === undefined) {
        prefs.searchBoxInfo = [600, 25, 600, 450];
    }
    localStorage.prefs = JSON.stringify(prefs);

    // XHR request from background process = load file data. Weird.
    function get_file_data(filename) {
        var request = new XMLHttpRequest();
        request.open("GET", filename, false);
        request.send();

        if(!request.responseText) {
            console.log("BPM: ERROR: Can't read from file: '" + filename + "'");
            return;
        } else {
            return request.responseText;
        }
    }

    // Content script requests
    opera.extension.onmessage = function(event) {
        var message = event.data;

        switch(message.method) {
            case "get_prefs":
                event.source.postMessage({
                    "method": "prefs",
                    "prefs": JSON.parse(localStorage.prefs)
                });
                break;

            case "set_prefs":
                localStorage.prefs = JSON.stringify(message.prefs);
                break;

            case "get_file":
                var data = get_file_data(message.filename);

                if(data) {
                    event.source.postMessage({
                        "method": "file_loaded",
                        "filename": message.filename,
                        "data": data
                    });
                }
                break;

            default:
                console.log("BPM: ERROR: Unknown request from content script: '" + message.request + "'");
                break;
        }
    };
  </script>
</head>
<body>
BetterPonymotes
</body>
</html>
